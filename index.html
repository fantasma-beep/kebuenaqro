<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kebuenaqro</title>
    <meta name="theme-color" content="#c2410c"/>
    <meta name="description" content="Reproductor de streaming de Kebuenaqro.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="manifest" href="manifest.json?v=7">

    <link rel="apple-touch-icon" href="https://fantasma-beep.github.io/kebuenaqro/logo-ke-buena-web.png?v=6">
    <link rel="apple-touch-icon" sizes="152x152" href="https://fantasma-beep.github.io/kebuenaqro/logo-ke-buena-web.png?v=6">
    <link rel="apple-touch-icon" sizes="180x180" href="https://fantasma-beep.github.io/kebuenaqro/logo-ke-buena-web.png?v=6">
    <link rel="apple-touch-icon" sizes="167x167" href="https://fantasma-beep.github.io/kebuenaqro/logo-ke-buena-web.png?v=6">

    <link rel="icon" type="image/png" sizes="32x32" href="https://fantasma-beep.github.io/kebuenaqro/logo-ke-buena-web.png?v=6">
    <link rel="icon" type="image/png" sizes="16x16" href="https://fantasma-beep.github.io/kebuenaqro/logo-ke-buena-web.png?v=6">

    <style>
        /* Tu CSS ... (sin cambios) */
    </style>
</head>
<body class="bg-slate-900 ...">
    
    <script>
        // --- INICIO: LÓGICA DE PWA (MODIFICADA) ---
        
        // 1. Registro del Service Worker simplificado
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado exitosamente.'))
                    .catch(err => console.error('Error al registrar SW:', err));
            });
        }

        const installBtn = document.getElementById('install-btn');
        const iosInstallBanner = document.getElementById('ios-install-banner');
        let deferredPrompt;

        const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isAppInstalled = () => window.matchMedia('(display-mode: standalone)').matches;

        window.addEventListener('appinstalled', () => {
            console.log('PWA instalada');
            installBtn.classList.add('hidden');
            iosInstallBanner.classList.add('hidden');
        });

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir que el mini-infobar aparezca en Chrome
            e.preventDefault();
            // Guardar el evento para dispararlo después
            deferredPrompt = e;
            
            // Mostrar el botón de instalación (solo si no está ya instalada)
            if (!isAppInstalled()) {
                console.log('Evento beforeinstallprompt disparado. Mostrando botón.');
                installBtn.classList.remove('hidden');
            }
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                // Mostrar el prompt de instalación
                deferredPrompt.prompt();
                // Esperar a que el usuario responda
                const { outcome } = await deferredPrompt.prompt();
                console.log(`Respuesta del usuario: ${outcome}`);
                // Ya no necesitamos el prompt, lo descartamos
                deferredPrompt = null;
                // Ocultar el botón
                installBtn.classList.add('hidden');
            }
        });

        // Mostrar banner de instrucciones para iOS
        if (isIOS() && !isAppInstalled()) {
            iosInstallBanner.classList.remove('hidden');
        }
        
        // --- FIN: LÓGICA DE PWA ---

        // El resto de tu código de inicialización... (sin cambios)
        window.addEventListener('DOMContentLoaded', () => {
            // ...tu código de splash, players, etc.
        });

        // ...tus funciones initializePlayer, populateNews, etc.
    </script>
</body>
</html>
